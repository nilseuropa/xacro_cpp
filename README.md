
This is a minimal, pure C++ port of core xacro functionality focused on common URDF workflows. It aims to be Python‑free and dependency‑light while matching Python xacro behavior for typical patterns used in robot descriptions.

### Supported Functionality
- **Arguments**: <xacro:arg name="..." default="..."/>
  - CLI overrides: pass as name:=value.
  - xacro:arg elements are removed from the final output after merging defaults and CLI.
- **Properties**: <xacro:property name="..." value="..."/>
  - Evaluated early and during expansion; property nodes are removed from final output.
- **Includes**: <xacro:include filename="..."/>
  - Relative paths resolve per‑file (nested includes use their own base directory).
  - Includes inside conditionals are discovered and expanded only for active branches.
- **Package lookup**: ${find('pkg')} and $(find pkg)
  - ament_index_cpp when available.
  - Fallback to AMENT_PREFIX_PATH / COLCON_PREFIX_PATH (…/share/pkg).
  - Last resort: source tree fallback near the current package (scans …/src/**/package.xml).
- **Substitutions** in attributes and text nodes
  - ${...} inside attribute values and element text.
  - $(arg name) anywhere in strings (outside ${...}).
  - Numeric expressions via tinyexpr: +, -, *, /, parentheses; pi constant.
  - Indexing for whitespace‑separated values: ${var[2]}.
  - ${find('pkg')} and $(find pkg) inside strings.
- **Conditionals**
  - <xacro:if value="..."> and <xacro:unless value="...">.
  - Evaluated with boolean semantics:
    - true/false (case‑insensitive), numeric non‑zero truthiness, and comparisons (==, !=, <, <=, >, >=) between identifiers, quoted strings, and numeric literals.
  - Inside macro bodies, conditionals use the macro’s local parameter/property scope and are spliced immediately.
- **Macros**
  - Define: <xacro:macro name="m" params="a b:=1 *origin">…</xacro:macro>
  - Call with or without prefix: <m a="..."/> or <xacro:m a="..."/>; also via <xacro:call macro="m"/>.
  - Parameter binding:
    - Positional via names in params; defaults with ":=".
    - Parameters can reference each other; resolved iteratively.
    - Macro parameters shadow global variables in the macro scope.
  - Block parameters (prefixed with “*” in params)
    - Captured from child elements of the call site whose tag matches the block name.
    - Spliced at <xacro:insert_block name="block"/> occurrences inside the macro body.
- **YAML loading** (subset)
  - ${xacro.load_yaml(path)} usable via property assignment: <xacro:property name="cfg" value="${xacro.load_yaml('file.yaml')}"/>
  - Access a top‑level list/scalar with: ${cfg['key']} → sets a space‑separated string; supports ${cfg['key'][i]} in expressions.
  - Supported YAML: top‑level keys with numeric scalars or lists (inline [1,2] or simple multi‑line "- 1").

### Behavioral Notes
- Processing order: args/props → includes → args/props again → collect macros → iterative expansion (conditionals/macros/substitutions until stable).
- Macro calls substitute attributes and text using the macro’s local scope. Nested macro calls expand in later iterations.
- Text node substitution ensures topics and other inline values evaluate correctly.

### Known Gaps / Differences vs Python xacro
- No Python eval/expression features; numeric math and simple comparisons only (no and/or/not operators).
- YAML parser is intentionally minimal (scalars/strings/bools/lists/maps with dot and [i] access). It does not stringify maps or support full Python xacro YAML features.
- Output formatting and attribute ordering may differ slightly; autogenerated header comments are not emitted.

| Feature                                   | Syntax                                                                  | xacro (ROS2) | xacro_cpp                      | Notes (xacro_cpp)                                                                 |
|-------------------------------------------|-------------------------------------------------------------------------|--------------|--------------------------------|------------------------------------------------------------------------------------|
| Disable lazy evaluation                   | `<xacro:property ... lazy_eval="false"/>`                               | ✅           | ❌                             | Skip                                                                               |
| Property forwarding                       | `params="arg1:=^"`                                      | ✅           | ❌                             | Skip                                                                               |
| Property removal                           | `<xacro:property name="p" remove="true"/>`                              | ✅           | ❌                             | Skip                                                                               |
| Keep comment                               | blank line before macro                                                 | ✅           | ❌                             | Skip                                                                               |
| Process comments                           | `<!-- xacro:eval-comments -->`                                          | ✅           | ❌                             | Skip                                                                               |
| Substitution arguments                    | `$(arg param_name)`                                                     | ✅           | ✅                             | OK                                                                                 |
| Default arguments                         | `<xacro:arg name="param_name" default=""/>`                             | ✅           | ✅                             | OK                                                                                 |
| Properties                                | `<xacro:property name="..." value="..."/>`                              | ✅           | ✅                             | OK                                                                                 |
| Expression evaluation                     | `${•}`                                                                  | Python       | tinyexpr (+, -, *, /, indexing `${var[2]}`, sin, cos, exp, abs, fabs) | OK                                 |
| Access property values                    | `${param_name}`                                                         | ✅           | ✅                             | OK                                                                                 |
| Xacro-specific functions                  | –                                                                       | load_yaml, dotify, print_location, abs_filename | load_yaml | OK |
| Lazy evaluation                           | property expr evaluated on first use                                    | ✅           | ✅                             | OK                                                                                 |
| Escaping dollar sign                      | `$$`                                                                    | ✅           | ✅                             | OK                                                                                 |
| Property blocks                           | `xacro:insert_block`                                                    | ✅           | ✅                             | OK                                                                                 |
| Macros                                    | `<xacro:macro name='m' ...>`                                            | ✅           | ✅                             | OK                                                                                 |
| Call macros                               | `<xacro:m .../>` or `<m .../>`                                          | ✅           | ✅                             | OK                                                                                 |
| Call macros (xacro:call)                  | `<xacro:call macro="bar"/>`                                             | ✅           | ✅                             | Supports dynamic macro names and block/regular parameters                          |
| Xacro attribute                           | `<xacro:attribute name="${name}" value="${value}"/>`                    | ✅           | ✅                             | OK                                                                                 |
| Xacro element                             | `<xacro:element xacro:name="${name}"/>`                                 | ✅           | ✅                            | OK                                                                                   |
| Block parameters                          | `params=*block1`                                                        | ✅           | ✅                             | OK                                                                                 |
| Default parameter values                   | `<xacro:macro name="foo" params="z:=0 text:='t' N:=${expr}"/>`          | ✅           | ✅                             | OK                                                                                 |
| Unique global namespace for subst. args   | –                                                                       | ✅           | ✅                             | OK                                                                                 |
| Macros have scoped namespaces             | –                                                                       | ✅           | ✅                             | OK                                                                                 |
| Include                                    | `<xacro:include filename="..."/>`                                       | ✅           | ✅                             | OK                                                                                 |
| Load YAML                                  | `<xacro:property name="props" value="${load_yaml(file)}"/>`             | ✅           | ✅                             | OK                                                                                 |
| Conditional blocks                         | `xacro:if`, `xacro:unless`                                              | ✅           | ✅                             | OK                                                                                 |
| Removal of comments                        | automatic                                                               | ✅           | ✅                             |                                              OK |
| Symbols and functions                     | –                                                                       | Python math (pi, sin, exp, fabs) | pi, sin, cos, exp, abs, fabs, etc... | OK  |
| Rospack commands                          | `$(•)`                                                                  | $(find pkg), $(cwd) | $(find pkg), `${find('pkg')}` | CAS-537: Add cwd support (To Do) |
| Call macros (xacro:call)                  | `<xacro:call macro="bar"/>`                                             | ✅           | ✅                             | OK                                                    |
| Headless block parameters                 | `params=**block2`                                                       | ✅           | ❌                             | CAS-541: Add headless block params                                          |
| Properties have scoped namespaces         | –                                                                       | ✅           | ✅                             | OK                                              |
| Property scope attribute                  | `scope="parent/global"`                                                 | ✅           | ✅                             | OK                                                |
| YAML capabilities                          | –                                                                       | Full         | Partial (scalars/strings/bools/lists/maps with dot/[i] access; no map-to-string) | CAS-544: Add full YAML        |
| Include with namespace                     | `<xacro:include filename="..." ns="A"/>`                                | ✅           | ❌                            | CAS-574: Add Include with namespace capability to xacro_cpp                                                                                     |
| Include optionally                         | `<xacro:include filename="..." optional="True"/>`                       | ✅           | ❌                             | CAS-575: Add optional xacro include capability to xacro_cpp                                                                                    |
| Property name validation                   | `<xacro:property name="valid_identifier"/>`                             | ✅           | ❌                             | CAS-576: Add property name validation capability to xacro_cpp                                                                                   |
| Double-underscore property guard           | `<xacro:property name="__hidden" .../>`                                 | ✅           | ❌                             | CAS-577: Add double-underscore property guard to xacro_cpp                                                                                   |
| Default property semantics                 | `<xacro:property name="p" default="..."/>`                              | ✅           | ✅                             | OK                                                                                 |
| Macro name with xacro: prefix              | `<xacro:macro name="xacro:foo">`                                        | ✅           | ❌                             | CAS-579: Disallow defining/invoking macros with reserved namespace (e.g. xacro) in xacro_cpp                                                                                   |

### API

Public headers live in `include/xacro_cpp/`.

Core types and entry points (from `xacro_cpp/processor.hpp`):
- `struct Options`: input/output paths and CLI argument overrides.
- `class Processor`: main expansion engine.
  - `bool run(const Options& opts, std::string* errorMsg)`
  - `bool runToString(const Options& opts, std::string* urdfXml, std::string* errorMsg)`
  - `bool collectArgs(const Options& opts, std::map<std::string, std::string>* argsOut, std::string* errorMsg)`
- Expression helpers:
  - `double evalNumber(const std::string& expr, const std::unordered_map<std::string, std::string>& vars, bool* ok = nullptr)`
  - `bool evalBool(const std::string& expr, const std::unordered_map<std::string, std::string>& vars)`
  - `std::string evalStringTemplate(const std::string& text, const std::unordered_map<std::string, std::string>& vars)`

Minimal usage example:
```cpp
#include "xacro_cpp/processor.hpp"

int main() {
  xacro_cpp::Options opts;
  opts.mInputPath = "robot.xacro";
  opts.mOutputPath = "robot.urdf";
  opts.mCliArgs["use_feature"] = "true";

  xacro_cpp::Processor processor;
  std::string errorMsg;
  if (!processor.run(opts, &errorMsg)) {
    return 1;
  }
  return 0;
}
```


### Build
Requires TinyXML2 development package installed on the system (e.g., libtinyxml2-dev).

As a plain CMake project:
```
mkdir build && cd build && cmake .. && make -j
```

In a ROS 2 workspace
```
colcon build --packages-select xacro_cpp
```

### CLI
```
xacro_cpp input.xacro [-o output.xml] [name:=value ...]
```

Examples
- Resolve package files: <xacro:include filename="$(find my_pkg)/xacro/part.xacro"/>
- Use args: <xacro:if value="$(arg use_feature)">…</xacro:if>
- Macro with block param:
  <xacro:macro name="wrap" params="name *origin">
    <link name="${name}"/>
    <joint name="${name}_joint" type="fixed">
      <xacro:insert_block name="origin"/>
    </joint>
  </xacro:macro>
  <xacro:wrap name="sensor">
    <origin xyz="0 0 0" rpy="0 0 0"/>
  </xacro:wrap>

Troubleshooting
- If a package cannot be found, ensure your ROS environment is sourced so ament index and AMENT_PREFIX_PATH are available. The source‑tree fallback covers typical dev layouts under …/src.
- If mutually exclusive branches both appear, check the conditional expression uses values available in that scope; string comparisons should be of the form ${side == 'left'} (quoted when ambiguous).

### Tests

The `test/test_xacro_parsing.cpp` fixture parses each sample with both Python `xacro` and this C++ port, then diff-checks the generated XML with a small Python script. The samples under `test/test_files/` cover expression evaluation, includes, conditionals, macros (including block parameters), YAML loading, and failure modes like duplicate symbols or broken includes.

#### Running the suite

1. Source your ROS 2 distro and a Python env that has `xacro` + deps:
   ```bash
   source /opt/ros/<distro>/setup.bash
   python3 -m pip install --user xacro catkin_pkg
   ```
2. Build with testing enabled:
   ```bash
   colcon build --packages-select xacro_cpp --cmake-args -DBUILD_TESTING=ON
   source install/setup.bash
   ```
3. Run either via ROS 2:
   ```bash
   ros2 run xacro_cpp test_xacro_parsing
   ```
   or with `colcon test`:
   ```bash
   colcon test --packages-select xacro_cpp --event-handlers console_direct+ --ctest-args -V
   ```
